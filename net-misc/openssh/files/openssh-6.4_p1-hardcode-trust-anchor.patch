From d540ff821e76f803e69753afa914088cf57c02ed Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ond=C5=99ej=20Caletka?= <ondrej@caletka.cz>
Date: Tue, 28 Jan 2014 12:34:41 +0100
Subject: [PATCH 5/5] Added hardcoded trust anchor

This patch adds a hardcoded trust anchor into getrrsetbyname-ldns.c.
Therefore it is possible to do DNSSEC validation without any external
dependencies.
---
 openbsd-compat/getrrsetbyname-ldns.c | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/openbsd-compat/getrrsetbyname-ldns.c b/openbsd-compat/getrrsetbyname-ldns.c
index d873888..8639a14 100644
--- a/openbsd-compat/getrrsetbyname-ldns.c
+++ b/openbsd-compat/getrrsetbyname-ldns.c
@@ -59,6 +59,13 @@
 #define malloc(x)	(xmalloc(x))
 #define calloc(x, y)	(xcalloc((x),(y)))
 
+static const char trust_anchor[] = ".       172800  IN      DNSKEY  257 3 8 "
+     "AwEAAagAIKlVZrpC6Ia7gEzahOR+9W29euxhJhVVLOyQbSEW0O8gcCjFFVQUTf6v58fLjw"
+     "Bd0YI0EzrAcQqBGCzh/RStIoO8g0NfnfL2MTJRkxoXbfDaUeVPQuYEhg37NZWAJQ9VnMVD"
+     "xP/VHL496M/QZxkjf5/Efucp2gaDX6RS6CXpoY68LsvPVjR0ZSwzz1apAzvN9dlzEheX7I"
+     "CJBBtuA6G3LQpzW5hOA2hzCTMjJPJ8LbqF6dsV6DoBQzgul0sGIcGOYl7OyQdXfZ57relS"
+     "Qageu+ipAdTTJ25AsRTAoub8ONGcLmqrAmRLKBP1dfwhYB4N7knNnulqQxA+Uk1ihz0=";
+
 int
 getrrsetbyname(const char *hostname, unsigned int rdclass,
 	       unsigned int rdtype, unsigned int flags,
@@ -159,6 +166,21 @@ getrrsetbyname(const char *hostname, unsigned int rdclass,
 	debug2("ldns: got %u signature(s) (RRTYPE %u) from DNS",
 	       rrset->rri_nsigs, LDNS_RR_TYPE_RRSIG);
 
+	if ((err = ldns_rr_new_frm_str(&rr, trust_anchor, 0, NULL, NULL))
+	     == LDNS_STATUS_OK) {
+		if ((err = ldns_resolver_push_dnssec_anchor(ldns_res, rr))
+		     == LDNS_STATUS_OK) {
+			ldns_rr_free(rr);
+		} else {
+			debug2("ldns: Trust anchor push failed: %s",
+			    ldns_get_errorstr_by_id(err));
+		}
+	} else {
+		debug2("ldns: Trust anchor read failed: %s",
+		    ldns_get_errorstr_by_id(err));
+	}
+
+
 	if ((err = ldns_verify_trusted(ldns_res, rrdata, rrsigs,
 	     trusted_keys)) == LDNS_STATUS_OK) {
 		rrset->rri_flags |= RRSET_VALIDATED;
-- 
1.8.3.2

